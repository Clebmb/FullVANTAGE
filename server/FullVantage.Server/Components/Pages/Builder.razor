@page "/builder"
@inject IHttpClientFactory HttpFactory

<h3>Client Builder</h3>

<div class="alert alert-info">Generate a self-contained agent executable configured to connect back to your server.</div>

<div class="row g-2 mb-3">
  <div class="col-md-2">
    <label>Scheme</label>
    <select class="form-select" @bind=Scheme>
      <option>http</option>
      <option>https</option>
    </select>
  </div>
  <div class="col-md-6">
    <label>Host</label>
    <input class="form-control" @bind=Host />
  </div>
  <div class="col-md-2">
    <label>Port</label>
    <input type="number" class="form-control" @bind=Port />
  </div>
  <div class="col-md-2">
    <label>Agent Type</label>
    <select class="form-select" @bind=AgentType>
      <option value="console">Console (Single File)</option>
      <option value="wpf">WPF (Multiple Files)</option>
    </select>
  </div>
</div>

<div class="row g-2">
  <div class="col-md-6">
    <a class="btn btn-primary w-100" href="@BuildUrl" target="_blank" rel="noopener">
      Download @(AgentType == "console" ? "Console" : "WPF") Agent
    </a>
  </div>
  <div class="col-md-6">
    <div class="alert alert-info mb-0">
      <strong>Console Agent:</strong> Single executable (~37MB), no GUI, perfect for servers and automation.<br/>
      <strong>WPF Agent:</strong> Multiple files (~100MB), includes GUI, better for desktop use.
    </div>
  </div>
</div>

@if (!string.IsNullOrEmpty(Status))
{
  <div class="alert alert-info mt-3">@Status</div>
}

@code {
  private string Scheme = "http";
  private string Host = "localhost";
  private int Port = 5118;
  private string AgentType = "console";
  private string? Status = string.Empty;

  protected override async Task OnInitializedAsync()
  {
    // Try to pull current server info as a convenience
    try
    {
      var client = HttpFactory.CreateClient();
      client.BaseAddress = new Uri(NavigationManager.BaseUri);
      var info = await client.GetFromJsonAsync<ServerInfo>("/api/server-info");
      if (info is not null && Uri.TryCreate(info.Url, UriKind.Absolute, out var u))
      {
        Scheme = u.Scheme;
        Host = u.Host;
        Port = u.Port;
      }
    }
    catch { }
  }

  [Inject]
  private NavigationManager NavigationManager { get; set; } = default!;

  private string BuildUrl => $"/api/build-agent?host={Uri.EscapeDataString(Host)}&port={Port}&scheme={Uri.EscapeDataString(Scheme)}&type={AgentType}&_ts={DateTimeOffset.UtcNow.ToUnixTimeSeconds()}";

  private sealed class ServerInfo { public string Url { get; set; } = string.Empty; }
}
